Bootstrap: localimage
From: pmn-deps.sif
%post

# Install dependencies
	apt update
	apt install -y unzip
	cpanm install LWP::Simple

# Set up the creation package
	mkdir -p /pmn/proj
	mkdir -p /pmn/pathway-tools
	cd /pmn
	git clone 'git@github-msu:CharlesHawkinsCarnegie/PMN-Pipeline.git' creation-package

# Download E2P2
	cd /pmn
	git clone 'https://github.com/carnegie/E2P2.git' E2P2
	cd E2P2
	mkdir rpsd_current
	cd rpsd_current
	priam_release=release_2019-03-07
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/README"
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/blastdb.tar.gz"
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/fasta.tar.gz"
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/maps.tar.gz"
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/profiles.tar.gz"
	curl -O "https://plantcyc-ftp.storage.googleapis.com/rpsd/$priam_release/weights.tar.gz"
	tar xf blastdb.tar.gz
	tar xf fasta.tar.gz
	tar xf maps.tar.gz
	tar xf profiles.tar.gz
	tar xf weights.tar.gz

# Get the BUSCO eukaryota database
	mkdir -p /pmn/busco
	cd /pmn/busco
	curl -O 'https://busco-data.ezlab.org/v4/data/lineages/eukaryota_odb10.2020-09-10.tar.gz'
	tar xf eukaryota_odb10.2020-09-10.tar.gz
	rm eukaryota_odb10.2020-09-10.tar.gz

# Put in the ptools version in the pgdb pipeline default config files and move them to where they go
	cd /pmn/creation-package/singularity
	PT_VER=27.0
	echo $PT_VER > /pmn/pt-version
	sed -i "s/\\\$PT_VER/$PT_VER/g" pgdb-pipeline.txt
	sed -i "s/\\\$PT_VER/$PT_VER/g" pmn-pipeline.conf
	mv pgdb-pipeline.txt ../project-template/
	mv pmn-pipeline.conf /etc/
	cd ..

# Download perlcyc
	cd perl_modules
	git clone 'https://github.com/solgenomics/perlcyc.git'
	mv perlcyc/lib/perlcyc.pm /pmn/creation-package/perl_scripts/

# Name of rpsblast has changed, scripts expect old name
	ln -s /usr/bin/rpsblast+ /usr/bin/rpsblast

# Download SAVI
	mkdir /pmn/savi
	cd /pmn/savi
	curl -O 'https://plantcyc.s3.amazonaws.com/SAVI3.1_pmn14.zip'
	unzip SAVI3.1_pmn14.zip
	rm SAVI3.1_pmn14.zip
	ln -s SAVI3.1_pmn14 current
	cd current
	chmod a+rx runSAVI3.1.sh
	ln -s runSAVI3.1.sh runSAVI.sh

%files
# Copy ssh keys - for dev only, to be removed when we make the PMN-Pipeline repository public
	/home/lynne/.ssh /root/.ssh

%environment
	echo ${LANGUAGE:=$LANG}
	echo ${LC_ALL:=$LANG}
	export LANGUAGE
	export LC_ALL
%runscript
	echo "This is the PMN base container. It is used to build pmn.sif. It does nothing when run directly."
