# Use this def file to create a PMN Singularity container with Pathway Tools installed
# Pathway Tools is proprietary software distributed by SRI International, and a license can be requested at http://bioinformatics.ai.sri.com/ptools/
# Please do not redistribute Singularity containers generated by this build script

Bootstrap: localimage
From: pmn-base.sif
%post
	export PT_VER=28.0
	echo "export PT_VER=$PT_VER" >> $SINGULARITY_ENVIRONMENT
	export PT_INSTALLER=pathway-tools-$PT_VER-linux-64-tier1-install
	/pmn/$PT_INSTALLER --InstallDir /pmn/pathway-tools --PTOOLS_LOCAL_PATH /pmn --InstallDesktopShortcuts 0 --mode unattended
	mkdir /pgdbs
	rmdir /pmn/ptools-local/pgdbs/user
	ln -s /pgdbs /pmn/ptools-local/pgdbs/user

# Start pathway tools and immediately exit; this is to trigger it to download patches
	echo '(exit)' | /pmn/pathway-tools/ptlisp
# Warn user not to redistribute the container
	echo -e "\nNote: The container file generated by this build script contains an installed copy of Pathway Tools $PT_VER, which is proprietary software distributed by SRI International (http://bioinformatics.ai.sri.com/ptools). For this reason, please do not redistribute the container without permission from SRI International\n"

%files
	pathway-tools-28.0-linux-64-tier1-install /pmn

%environment
# Set language / locale variables
	echo ${LANGUAGE:=$LANG}
	echo ${LC_ALL:=$LANG}
	export LANGUAGE
	export LC_ALL

	export PMN_PGP=/pmn/creation-package
	export PATH=$PATH:$PMN_PGP/bin
	export PT_VER=$(cat /pmn/pt-version)
	export PT_LOC=/pmn/ptools-local
	export PT_APP=/pmn/pathway-tools
	export PT_EXE=$PT_APP/aic-export/pathway-tools/ptools/$PT_VER/pathway-tools
	export PMN_PGDBS=/$PT_LOC/pgdbs/user
	export PMN_METACYC=$PT_APP/aic-export/pgdbs/metacyc
	export PMN_PLANTCYC=$PMN_PGDBS/plantcyc
	export PMN_PROJ=/pmn/proj
	export PMN_BIN=$PMN_PGP/bin
	export PMN_PERL_SCRIPTS=$PMN_PGP/perl_scripts
	export PMN_PERL_MODS=$PMN_PGP/perl_modules
	export PMN_E2P2=/pmn/E2P2
	export PMN_E2P2_RPSD=5.2
	export PMN_LISP=$PMN_PGP/lisp
	export PMN_LISP_FUNS=$PMN_LISP/pmn-lisp-funs.lisp
	export PMN_BUSCO=/pmn/busco
	export PMN_BUSCO_DB=eukaryota
	export PERL5LIB=$PMN_PERL_SCRIPTS

	export PMN_VENV=/pmn/venv

%runscript
	$PMN_VENV/bin/python3 $PMN_BIN/pmn-pipeline $*
